<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAC GOOD WORKS ASSEMBLY - Evangelism Tracking System</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- DataTables for enhanced tables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <!-- FullCalendar for scheduling -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
    <style>
        /* ============================================
           SYSTEM THEME & STYLES
           ============================================ */
        :root {
            --primary: #4A0072;
            --secondary: #FFD700;
            --accent: #8A2BE2;
            --light: #F8F9FA;
            --dark: #212529;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --radius: 15px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark);
            min-height: 100vh;
            padding-bottom: 50px;
        }

        /* ============================================
           OFFLINE MODE INDICATOR
           ============================================ */
        .offline-banner {
            background: linear-gradient(to right, #ff9800, #ff5722);
            color: white;
            text-align: center;
            padding: 12px;
            font-weight: bold;
            display: none;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .offline-banner i {
            margin-right: 10px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* ============================================
           SYSTEM CONTAINERS
           ============================================ */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ============================================
           HEADER & LOGO AREA
           ============================================ */
        header {
            background: linear-gradient(to right, var(--primary), var(--accent));
            color: white;
            padding: 25px;
            border-radius: var(--radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,215,0,0.1) 0%, transparent 70%);
            z-index: 0;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 20px;
            z-index: 1;
        }

        .logo-placeholder {
            width: 80px;
            height: 80px;
            background: var(--secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 3px solid white;
        }

        .church-info h1 {
            font-size: 2.2rem;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .church-info h2 {
            font-size: 1.5rem;
            color: var(--secondary);
            font-weight: 400;
            margin-bottom: 10px;
        }

        .church-info p {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .church-info i {
            color: var(--secondary);
        }

        /* ============================================
           USER INFO & LOGOUT
           ============================================ */
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            border-radius: var(--radius);
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1;
        }

        .user-info i {
            font-size: 1.8rem;
            color: var(--secondary);
        }

        .user-details h3 {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .user-details .role {
            font-size: 0.9rem;
            opacity: 0.9;
            background: rgba(255,255,255,0.2);
            padding: 2px 10px;
            border-radius: 20px;
            display: inline-block;
        }

        .user-details .group-badge {
            font-size: 0.8rem;
            background: var(--secondary);
            color: var(--primary);
            padding: 2px 10px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 5px;
            font-weight: bold;
        }

        .logout-btn {
            background: var(--secondary);
            color: var(--primary);
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logout-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            background: white;
        }

        /* ============================================
           MAIN CONTENT LAYOUT
           ============================================ */
        .main-content {
            display: none;
            grid-template-columns: 280px 1fr;
            gap: 30px;
        }

        /* ============================================
           SIDEBAR NAVIGATION
           ============================================ */
        .sidebar {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            height: fit-content;
        }

        .sidebar nav ul {
            list-style: none;
        }

        .sidebar nav li {
            margin-bottom: 10px;
        }

        .sidebar nav a {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            color: var(--dark);
            text-decoration: none;
            border-radius: 10px;
            transition: var(--transition);
            font-weight: 500;
        }

        .sidebar nav a:hover {
            background: rgba(74, 0, 114, 0.1);
            transform: translateX(5px);
        }

        .sidebar nav a.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(74, 0, 114, 0.3);
        }

        .sidebar nav i {
            width: 25px;
            text-align: center;
            font-size: 1.2rem;
        }

        /* ============================================
           SYSTEM STATUS PANEL
           ============================================ */
        .system-status {
            margin-top: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .system-status h4 {
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .status-item i {
            width: 20px;
        }

        .online { color: var(--success); }
        .offline { color: var(--warning); }
        .syncing { color: var(--info); }

        /* ============================================
           DASHBOARD STYLES
           ============================================ */
        .dashboard {
            display: grid;
            gap: 30px;
        }

        .page {
            display: none;
            background: white;
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
            animation: fadeIn 0.5s;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ============================================
           STATS CARDS
           ============================================ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: var(--transition);
            border-left: 5px solid var(--primary);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }

        .souls-icon { background: rgba(76, 175, 80, 0.1); color: #4CAF50; }
        .reports-icon { background: rgba(33, 150, 243, 0.1); color: #2196F3; }
        .members-icon { background: rgba(156, 39, 176, 0.1); color: #9C27B0; }
        .followup-icon { background: rgba(255, 152, 0, 0.1); color: #FF9800; }
        .groups-icon { background: rgba(74, 0, 114, 0.1); color: var(--primary); }

        .stat-info h3 {
            font-size: 2.5rem;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .stat-info p {
            color: #666;
            font-size: 0.9rem;
        }

        /* ============================================
           CHARTS CONTAINER
           ============================================ */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }

        .chart-card {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
        }

        .chart-card h3 {
            margin-bottom: 20px;
            color: var(--primary);
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        /* ============================================
           PAGE HEADERS
           ============================================ */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .page-header h2 {
            color: var(--primary);
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ============================================
           ACTION BUTTONS
           ============================================ */
        .action-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: var(--transition);
        }

        .action-btn:hover {
            background: var(--accent);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .action-btn.secondary {
            background: var(--secondary);
            color: var(--primary);
        }

        .action-btn.success {
            background: var(--success);
        }

        .action-btn.warning {
            background: var(--warning);
            color: var(--dark);
        }

        .action-btn.danger {
            background: var(--danger);
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        /* ============================================
           FILTER CONTROLS
           ============================================ */
        .filter-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-controls .form-control {
            width: auto;
            min-width: 150px;
        }

        /* ============================================
           FORM STYLES
           ============================================ */
        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 0, 114, 0.1);
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        /* ============================================
           MEMBERS CHECKLIST
           ============================================ */
        .members-checklist {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9f9f9;
        }

        .member-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #eee;
        }

        .member-item:hover {
            background: #f0f0f0;
        }

        /* ============================================
           DATA TABLES
           ============================================ */
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th {
            background: var(--primary);
            color: white;
            text-align: left;
            padding: 15px;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .data-table tr:hover {
            background: #f9f9f9;
        }

        .data-table .actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        /* ============================================
           GROUP BADGES
           ============================================ */
        .group-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .group-1 { background: #E3F2FD; color: #1565C0; }
        .group-2 { background: #F3E5F5; color: #7B1FA2; }
        .group-3 { background: #E8F5E9; color: #2E7D32; }
        .group-4 { background: #FFF3E0; color: #EF6C00; }

        /* ============================================
           LOGIN SCREEN
           ============================================ */
        .login-container {
            max-width: 500px;
            margin: 100px auto;
            background: white;
            border-radius: var(--radius);
            padding: 40px;
            box-shadow: var(--shadow);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(to right, var(--primary), var(--accent));
        }

        .login-header {
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .login-header p {
            color: #666;
        }

        /* ============================================
           ROLE SELECTOR
           ============================================ */
        .role-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .role-option {
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .role-option:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .role-option.selected {
            border-color: var(--primary);
            background: rgba(74, 0, 114, 0.05);
            box-shadow: 0 5px 15px rgba(74, 0, 114, 0.1);
        }

        .role-option i {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .role-option h3 {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .role-option p {
            font-size: 0.9rem;
            color: #666;
        }

        /* ============================================
           LOGIN FORM
           ============================================ */
        .login-form {
            text-align: left;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .login-btn:hover {
            background: var(--accent);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* ============================================
           DEFAULT LOGINS DISPLAY
           ============================================ */
        .default-logins {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            text-align: left;
        }

        .default-logins h4 {
            color: var(--primary);
            margin-bottom: 15px;
            text-align: center;
        }

        .login-item {
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border-left: 3px solid var(--primary);
        }

        /* ============================================
           GROUPS DISPLAY
           ============================================ */
        .groups-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }

        .group-card {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .group-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.1);
        }

        .group-card h3 {
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .group-leaders {
            background: rgba(74, 0, 114, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .group-leaders p {
            margin-bottom: 5px;
            font-weight: 600;
        }

        .group-members {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
        }

        .member-card {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 3px solid var(--secondary);
        }

        /* ============================================
           EXPORT CARDS
           ============================================ */
        .export-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .export-card {
            background: white;
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border-top: 5px solid var(--primary);
        }

        .export-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }

        .export-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 2.5rem;
        }

        .pdf-icon { background: rgba(244, 67, 54, 0.1); color: #F44336; }
        .excel-icon { background: rgba(76, 175, 80, 0.1); color: #4CAF50; }
        .json-icon { background: rgba(33, 150, 243, 0.1); color: #2196F3; }
        .print-icon { background: rgba(156, 39, 176, 0.1); color: #9C27B0; }

        /* ============================================
           MODAL STYLES
           ============================================ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-header h3 {
            color: var(--primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            transition: var(--transition);
        }

        .close-modal:hover {
            color: var(--danger);
        }

        /* ============================================
           FOLLOW-UP TRACKER
           ============================================ */
        .followup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .followup-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--success);
        }

        .followup-card.pending {
            border-left-color: var(--warning);
        }

        .followup-card.overdue {
            border-left-color: var(--danger);
        }

        .followup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .followup-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-completed { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-overdue { background: #f8d7da; color: #721c24; }

        /* ============================================
           CALENDAR STYLES
           ============================================ */
        #calendar {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-top: 20px;
        }

        /* ============================================
           FOOTER
           ============================================ */
        .footer {
            text-align: center;
            margin-top: 50px;
            color: #666;
            font-size: 0.9rem;
            padding: 20px;
            border-top: 1px solid #eee;
        }

        .footer p {
            margin-bottom: 5px;
        }

        /* ============================================
           RESPONSIVE DESIGN
           ============================================ */
        @media (max-width: 1200px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .groups-container {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
        }

        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: 2;
            }
            
            .dashboard {
                order: 1;
            }
            
            .role-selector {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .user-info {
                align-self: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-controls .form-control {
                width: 100%;
            }
            
            .page-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .btn-group {
                flex-direction: column;
                width: 100%;
            }
            
            .btn-group .action-btn {
                width: 100%;
            }
        }

        @media (max-width: 576px) {
            .container {
                padding: 10px;
            }
            
            .page {
                padding: 20px;
            }
            
            .login-container {
                margin: 50px auto;
                padding: 20px;
            }
            
            .export-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ============================================
           ANIMATIONS
           ============================================ */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ============================================
           CUSTOM SCROLLBAR
           ============================================ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }
    </style>
</head>
<body>
    <!-- ============================================
         OFFLINE MODE BANNER
         ============================================ -->
    <div class="offline-banner" id="offlineBanner">
        <i class="fas fa-wifi-slash"></i> You are currently in OFFLINE MODE. Data will sync when internet is restored.
    </div>

    <!-- ============================================
         LOGIN SCREEN
         ============================================ -->
    <div class="login-container" id="loginScreen">
        <div class="login-header">
            <div class="logo-placeholder">CGWA</div>
            <h1>CAC GOOD WORKS ASSEMBLY</h1>
            <p>Evangelism Tracking & Analytics Dashboard</p>
            <p><i class="fas fa-user-tie"></i> Pastor: Pastor AKIN | <i class="fas fa-cross"></i> Evangelist: Bro Moses</p>
        </div>
        
        <div class="role-selector" id="roleSelector">
            <div class="role-option" data-role="pastor">
                <i class="fas fa-user-shield"></i>
                <h3>Pastor (Admin)</h3>
                <p>Full System Access</p>
            </div>
            <div class="role-option" data-role="evangelist">
                <i class="fas fa-cross"></i>
                <h3>Evangelist</h3>
                <p>Reports & Dashboards</p>
            </div>
            <div class="role-option" data-role="team-leader">
                <i class="fas fa-users"></i>
                <h3>Team Leader</h3>
                <p>Group Reports</p>
            </div>
            <div class="role-option" data-role="guest">
                <i class="fas fa-eye"></i>
                <h3>Guest View</h3>
                <p>Limited Access</p>
            </div>
        </div>
        
        <div class="login-form" id="loginForm">
            <div class="form-group">
                <label for="username">Username / Email</label>
                <input type="text" id="username" class="form-control" placeholder="Enter your username or email">
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter your password">
            </div>
            
            <div class="form-group" id="groupSelection" style="display: none;">
                <label for="group">Select Your Group</label>
                <select id="group" class="form-control">
                    <option value="">-- Select Group --</option>
                    <option value="1">Group 1 - Dr Mrs Akinbajo & Bro Michael Awopeju</option>
                    <option value="2">Group 2 - Bro Tolu Adesanya & Sis Folashade Adegoke</option>
                    <option value="3">Group 3 - Bro Moses Awopeju & Mrs Ajidagba</option>
                    <option value="4">Group 4 - Bro Korede Towolawi & Elder Obajuluwa & Bro Abraham Awopeju</option>
                </select>
            </div>
            
            <button class="login-btn" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i> Login to System
            </button>
            
            <div class="default-logins">
                <h4>Default Login Credentials</h4>
                <div class="login-item">
                    <strong>Pastor (Admin):</strong> pastor@cacgoodworks.org / Pastor@2026
                </div>
                <div class="login-item">
                    <strong>Evangelist:</strong> evangelist@cacgoodworks.org / Evangelist@2026
                </div>
                <div class="login-item">
                    <strong>Team Leaders:</strong> g1leader / Group1@2026, g2leader / Group2@2026, etc.
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         MAIN APPLICATION CONTAINER
         ============================================ -->
    <div class="container" id="appContainer" style="display: none;">
        <header>
            <div class="logo-area">
                <div class="logo-placeholder">CGWA</div>
                <div class="church-info">
                    <h1>CAC GOOD WORKS ASSEMBLY</h1>
                    <h2>Evangelism Tracking & Analytics Dashboard</h2>
                    <p><i class="fas fa-user-tie"></i> Pastor: Pastor AKIN | <i class="fas fa-cross"></i> Evangelist: Bro Moses</p>
                </div>
            </div>
            
            <div class="user-info">
                <i class="fas fa-user-circle" id="userIcon"></i>
                <div class="user-details">
                    <h3 id="currentUserName">Guest User</h3>
                    <div class="role" id="currentUserRole">Guest</div>
                    <div id="currentUserGroup" class="group-badge"></div>
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>
        
        <div class="main-content" id="mainContent">
            <!-- ============================================
                 SIDEBAR NAVIGATION
                 ============================================ -->
            <aside class="sidebar">
                <nav>
                    <ul>
                        <li><a href="#" class="nav-link active" data-page="dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                        <li><a href="#" class="nav-link" data-page="new-report"><i class="fas fa-plus-circle"></i> New Report</a></li>
                        <li><a href="#" class="nav-link" data-page="reports"><i class="fas fa-file-alt"></i> View Reports</a></li>
                        <li><a href="#" class="nav-link" data-page="followups"><i class="fas fa-handshake"></i> Follow-ups</a></li>
                        <li><a href="#" class="nav-link" data-page="groups"><i class="fas fa-users"></i> Groups & Members</a></li>
                        <li><a href="#" class="nav-link" data-page="calendar"><i class="fas fa-calendar-alt"></i> Calendar</a></li>
                        <li><a href="#" class="nav-link" data-page="analytics"><i class="fas fa-chart-bar"></i> Analytics</a></li>
                        <li><a href="#" class="nav-link" data-page="export"><i class="fas fa-download"></i> Export Data</a></li>
                        <li><a href="#" class="nav-link" data-page="settings"><i class="fas fa-cog"></i> Settings</a></li>
                    </ul>
                </nav>
                
                <div class="system-status">
                    <h4><i class="fas fa-server"></i> System Status</h4>
                    <div class="status-item">
                        <i class="fas fa-wifi" id="connectionIcon"></i>
                        <span id="connectionStatus">Online - Connected</span>
                    </div>
                    <div class="status-item">
                        <i class="fas fa-database"></i>
                        <span id="storageStatus">Local Storage: Active</span>
                    </div>
                    <div class="status-item">
                        <i class="fas fa-sync"></i>
                        <span id="syncStatus">Last Sync: Just now</span>
                    </div>
                </div>
            </aside>
            
            <!-- ============================================
                 MAIN CONTENT AREA
                 ============================================ -->
            <main class="dashboard">
                <!-- DASHBOARD PAGE -->
                <div class="page active" id="dashboard-page">
                    <div class="page-header">
                        <h2><i class="fas fa-home"></i> Evangelism Dashboard</h2>
                        <div class="filter-controls">
                            <input type="date" id="dateFrom" class="form-control">
                            <input type="date" id="dateTo" class="form-control">
                            <select id="groupFilter" class="form-control">
                                <option value="all">All Groups</option>
                                <option value="1">Group 1</option>
                                <option value="2">Group 2</option>
                                <option value="3">Group 3</option>
                                <option value="4">Group 4</option>
                            </select>
                            <button class="action-btn" id="applyFilter">
                                <i class="fas fa-filter"></i> Apply
                            </button>
                            <button class="action-btn secondary" id="resetFilter">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon souls-icon">
                                <i class="fas fa-hands-praying"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalSouls">0</h3>
                                <p>Total Souls Won</p>
                                <small id="soulsChange" class="positive">+0 this month</small>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon reports-icon">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalReports">0</h3>
                                <p>Evangelism Reports</p>
                                <small id="reportsChange" class="positive">+0 this month</small>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon members-icon">
                                <i class="fas fa-user-friends"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalParticipants">0</h3>
                                <p>Active Participants</p>
                                <small id="participantsChange" class="positive">+0 this month</small>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon followup-icon">
                                <i class="fas fa-handshake"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalFollowups">0</h3>
                                <p>Follow-ups Required</p>
                                <small id="followupsChange" class="positive">+0 pending</small>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon groups-icon">
                                <i class="fas fa-church"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalGroups">4</h3>
                                <p>Evangelism Groups</p>
                                <small>60 total members</small>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon souls-icon">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="conversionRate">0%</h3>
                                <p>Conversion Rate</p>
                                <small>Based on total reached</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="charts-container">
                        <div class="chart-card">
                            <h3><i class="fas fa-chart-bar"></i> Souls Won by Group</h3>
                            <div class="chart-container">
                                <canvas id="soulsChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <h3><i class="fas fa-chart-line"></i> Evangelism Activity</h3>
                            <div class="chart-container">
                                <canvas id="activityChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <h3><i class="fas fa-chart-pie"></i> Participation by Group</h3>
                            <div class="chart-container">
                                <canvas id="participationChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <h3><i class="fas fa-chart-donut"></i> Conversions vs Follow-ups</h3>
                            <div class="chart-container">
                                <canvas id="conversionsChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-card" style="margin-top: 30px;">
                        <h3><i class="fas fa-trophy"></i> Top Performers This Month</h3>
                        <div id="topPerformers" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                            <!-- Top performers will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- NEW REPORT PAGE -->
                <div class="page" id="new-report-page">
                    <div class="page-header">
                        <h2><i class="fas fa-plus-circle"></i> New Evangelism Report</h2>
                        <div class="btn-group">
                            <button class="action-btn secondary" id="saveDraftBtn">
                                <i class="fas fa-save"></i> Save Draft
                            </button>
                            <button class="action-btn warning" id="loadDraftBtn">
                                <i class="fas fa-file-import"></i> Load Draft
                            </button>
                        </div>
                    </div>
                    
                    <form id="reportForm">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                            <div>
                                <div class="form-group">
                                    <label for="reportDate">Date of Evangelism *</label>
                                    <input type="date" id="reportDate" class="form-control" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="location">Location / Community *</label>
                                    <input type="text" id="location" class="form-control" placeholder="Enter evangelism location" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="groupNumber">Group Number *</label>
                                    <select id="groupNumber" class="form-control" required>
                                        <option value="">-- Select Group --</option>
                                        <option value="1">Group 1 - Dr Mrs Akinbajo & Bro Michael Awopeju</option>
                                        <option value="2">Group 2 - Bro Tolu Adesanya & Sis Folashade Adegoke</option>
                                        <option value="3">Group 3 - Bro Moses Awopeju & Mrs Ajidagba</option>
                                        <option value="4">Group 4 - Bro Korede Towolawi & Elder Obajuluwa & Bro Abraham Awopeju</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="teamLeader">Team Leader *</label>
                                    <input type="text" id="teamLeader" class="form-control" readonly>
                                </div>
                            </div>
                            
                            <div>
                                <div class="form-group">
                                    <label for="totalReached">Total People Reached *</label>
                                    <input type="number" id="totalReached" class="form-control" min="0" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="soulsWon">Souls Won *</label>
                                    <input type="number" id="soulsWon" class="form-control" min="0" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="followups">Follow-ups Required</label>
                                    <input type="number" id="followups" class="form-control" min="0" value="0">
                                </div>
                                
                                <div class="form-group">
                                    <label>Report Type</label>
                                    <div style="display: flex; gap: 15px;">
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="radio" name="reportType" value="outreach" checked> Outreach
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="radio" name="reportType" value="followup"> Follow-up Visit
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="radio" name="reportType" value="training"> Training Session
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Members Who Participated *</label>
                            <div class="members-checklist" id="membersChecklist">
                                <!-- Members will be loaded dynamically -->
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                            <div class="form-group">
                                <label for="testimonies">Testimonies / Observations</label>
                                <textarea id="testimonies" class="form-control" rows="4" placeholder="Share testimonies or observations from the outreach"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="challenges">Challenges Encountered</label>
                                <textarea id="challenges" class="form-control" rows="4" placeholder="Describe any challenges faced during evangelism"></textarea>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="recommendations">Recommendations</label>
                            <textarea id="recommendations" class="form-control" rows="3" placeholder="Provide recommendations for future evangelism efforts"></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-top: 30px;">
                            <button type="submit" class="action-btn" style="flex: 2;">
                                <i class="fas fa-paper-plane"></i> Submit Report
                            </button>
                            <button type="button" class="action-btn danger" id="clearFormBtn" style="flex: 1;">
                                <i class="fas fa-trash"></i> Clear Form
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- VIEW REPORTS PAGE -->
                <div class="page" id="reports-page">
                    <div class="page-header">
                        <h2><i class="fas fa-file-alt"></i> Evangelism Reports</h2>
                        <div class="filter-controls">
                            <select id="reportGroupFilter" class="form-control">
                                <option value="all">All Groups</option>
                                <option value="1">Group 1</option>
                                <option value="2">Group 2</option>
                                <option value="3">Group 3</option>
                                <option value="4">Group 4</option>
                            </select>
                            <select id="reportTypeFilter" class="form-control">
                                <option value="all">All Types</option>
                                <option value="outreach">Outreach</option>
                                <option value="followup">Follow-up</option>
                                <option value="training">Training</option>
                            </select>
                            <input type="date" id="reportDateFilter" class="form-control">
                            <button class="action-btn" id="searchReports">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="data-table" id="reportsTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Group</th>
                                    <th>Location</th>
                                    <th>Type</th>
                                    <th>Participants</th>
                                    <th>Reached</th>
                                    <th>Souls</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reportsTableBody">
                                <!-- Reports will be loaded dynamically -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <div id="reportsCount">0 reports found</div>
                        <div class="btn-group">
                            <button class="action-btn secondary" id="prevPage">
                                <i class="fas fa-chevron-left"></i> Previous
                            </button>
                            <span style="padding: 10px 20px; background: #f8f9fa; border-radius: 5px;">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
                            <button class="action-btn secondary" id="nextPage">
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- FOLLOW-UPS PAGE -->
                <div class="page" id="followups-page">
                    <div class="page-header">
                        <h2><i class="fas fa-handshake"></i> Follow-up Tracker</h2>
                        <div class="btn-group">
                            <button class="action-btn" id="addFollowupBtn">
                                <i class="fas fa-plus"></i> Add Follow-up
                            </button>
                            <button class="action-btn success" id="markCompletedBtn">
                                <i class="fas fa-check"></i> Mark Completed
                            </button>
                        </div>
                    </div>
                    
                    <div class="filter-controls" style="margin-bottom: 30px;">
                        <select id="followupStatusFilter" class="form-control">
                            <option value="all">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="completed">Completed</option>
                            <option value="overdue">Overdue</option>
                        </select>
                        <select id="followupGroupFilter" class="form-control">
                            <option value="all">All Groups</option>
                            <option value="1">Group 1</option>
                            <option value="2">Group 2</option>
                            <option value="3">Group 3</option>
                            <option value="4">Group 4</option>
                        </select>
                        <button class="action-btn secondary" id="refreshFollowups">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    
                    <div class="followup-grid" id="followupContainer">
                        <!-- Follow-up cards will be loaded here -->
                    </div>
                </div>
                
                <!-- GROUPS & MEMBERS PAGE -->
                <div class="page" id="groups-page">
                    <div class="page-header">
                        <h2><i class="fas fa-users"></i> Evangelism Groups & Members</h2>
                        <button class="action-btn secondary" id="refreshGroupsBtn">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    
                    <div class="groups-container" id="groupsContainer">
                        <!-- Groups will be loaded dynamically -->
                    </div>
                </div>
                
                <!-- CALENDAR PAGE -->
                <div class="page" id="calendar-page">
                    <div class="page-header">
                        <h2><i class="fas fa-calendar-alt"></i> Evangelism Calendar</h2>
                        <div class="btn-group">
                            <button class="action-btn" id="addEventBtn">
                                <i class="fas fa-plus"></i> Add Event
                            </button>
                            <button class="action-btn secondary" id="todayBtn">
                                <i class="fas fa-calendar-day"></i> Today
                            </button>
                        </div>
                    </div>
                    
                    <div id="calendar"></div>
                </div>
                
                <!-- ANALYTICS PAGE -->
                <div class="page" id="analytics-page">
                    <div class="page-header">
                        <h2><i class="fas fa-chart-bar"></i> Advanced Analytics</h2>
                        <div class="filter-controls">
                            <select id="analyticsPeriod" class="form-control">
                                <option value="week">Last Week</option>
                                <option value="month" selected>Last Month</option>
                                <option value="quarter">Last Quarter</option>
                                <option value="year">Last Year</option>
                                <option value="all">All Time</option>
                            </select>
                            <button class="action-btn" id="refreshAnalytics">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon souls-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="avgSouls">0</h3>
                                <p>Avg. Souls per Outreach</p>
                                <small id="avgSoulsChange" class="positive">+0 vs last period</small>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon reports-icon">
                                <i class="fas fa-map-marked-alt"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="topLocation">-</h3>
                                <p>Most Productive Location</p>
                                <small id="locationStats">0 reports</small>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon members-icon">
                                <i class="fas fa-user-check"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="topParticipant">-</h3>
                                <p>Most Active Participant</p>
                                <small id="participantStats">0 outreaches</small>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon followup-icon">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="conversionRateDetailed">0%</h3>
                                <p>Overall Conversion Rate</p>
                                <small id="conversionTrend">0% trend</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="charts-container">
                        <div class="chart-card">
                            <h3><i class="fas fa-radar"></i> Group Performance Comparison</h3>
                            <div class="chart-container">
                                <canvas id="performanceChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <h3><i class="fas fa-chart-line"></i> Monthly Progress</h3>
                            <div class="chart-container">
                                <canvas id="monthlyChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <h3><i class="fas fa-chart-donut"></i> Follow-up Status</h3>
                            <div class="chart-container">
                                <canvas id="followupStatusChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <h3><i class="fas fa-chart-bar"></i> Outreach Types Distribution</h3>
                            <div class="chart-container">
                                <canvas id="outreachTypesChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-card" style="margin-top: 30px;">
                        <h3><i class="fas fa-table"></i> Detailed Analytics Table</h3>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Metric</th>
                                        <th>Group 1</th>
                                        <th>Group 2</th>
                                        <th>Group 3</th>
                                        <th>Group 4</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody id="analyticsTableBody">
                                    <!-- Analytics data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- EXPORT DATA PAGE -->
                <div class="page" id="export-page">
                    <div class="page-header">
                        <h2><i class="fas fa-download"></i> Export Data</h2>
                    </div>
                    
                    <div class="export-grid">
                        <div class="export-card" id="exportPDF">
                            <div class="export-icon pdf-icon">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <h3>PDF Report</h3>
                            <p>Generate detailed PDF report with church branding and pastor approval footer</p>
                            <div style="margin-top: 15px; font-size: 0.9rem; color: #666;">
                                <i class="fas fa-check-circle"></i> Monthly summaries included
                            </div>
                        </div>
                        
                        <div class="export-card" id="exportExcel">
                            <div class="export-icon excel-icon">
                                <i class="fas fa-file-excel"></i>
                            </div>
                            <h3>Excel Export</h3>
                            <p>Export all evangelism records to Excel format with group-based sheets</p>
                            <div style="margin-top: 15px; font-size: 0.9rem; color: #666;">
                                <i class="fas fa-check-circle"></i> One-click export
                            </div>
                        </div>
                        
                        <div class="export-card" id="exportJSON">
                            <div class="export-icon json-icon">
                                <i class="fas fa-file-code"></i>
                            </div>
                            <h3>Backup Data</h3>
                            <p>Download complete database backup in JSON format for import/restore</p>
                            <div style="margin-top: 15px; font-size: 0.9rem; color: #666;">
                                <i class="fas fa-check-circle"></i> Full system backup
                            </div>
                        </div>
                        
                        <div class="export-card" id="exportPrint">
                            <div class="export-icon print-icon">
                                <i class="fas fa-print"></i>
                            </div>
                            <h3>Print Summary</h3>
                            <p>Print evangelism summary report optimized for paper printing</p>
                            <div style="margin-top: 15px; font-size: 0.9rem; color: #666;">
                                <i class="fas fa-check-circle"></i> Printer-friendly format
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-card" style="margin-top: 30px;">
                        <h3><i class="fas fa-cogs"></i> Custom Export Settings</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="form-group">
                                <label for="exportStartDate">Start Date</label>
                                <input type="date" id="exportStartDate" class="form-control">
                            </div>
                            
                            <div class="form-group">
                                <label for="exportEndDate">End Date</label>
                                <input type="date" id="exportEndDate" class="form-control">
                            </div>
                            
                            <div class="form-group">
                                <label for="exportGroup">Group Filter</label>
                                <select id="exportGroup" class="form-control">
                                    <option value="all">All Groups</option>
                                    <option value="1">Group 1</option>
                                    <option value="2">Group 2</option>
                                    <option value="3">Group 3</option>
                                    <option value="4">Group 4</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="exportFormat">Format</label>
                                <select id="exportFormat" class="form-control">
                                    <option value="detailed">Detailed Report</option>
                                    <option value="summary">Summary Only</option>
                                    <option value="raw">Raw Data</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; display: flex; gap: 15px;">
                            <button class="action-btn" id="generateExport">
                                <i class="fas fa-cogs"></i> Generate Custom Export
                            </button>
                            <button class="action-btn secondary" id="previewExport">
                                <i class="fas fa-eye"></i> Preview
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- SETTINGS PAGE -->
                <div class="page" id="settings-page">
                    <div class="page-header">
                        <h2><i class="fas fa-cog"></i> System Settings</h2>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div class="chart-card">
                            <h3><i class="fas fa-user-shield"></i> User Management</h3>
                            <div class="form-group">
                                <label>Current User Role</label>
                                <div style="padding: 15px; background: #f8f9fa; border-radius: 10px;">
                                    <strong id="currentRoleDisplay">Guest</strong>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Permissions</label>
                                <div id="permissionsList" style="padding: 15px; background: #f8f9fa; border-radius: 10px;">
                                    <!-- Permissions will be listed here -->
                                </div>
                            </div>
                            
                            <button class="action-btn" id="changePasswordBtn">
                                <i class="fas fa-key"></i> Change Password
                            </button>
                        </div>
                        
                        <div class="chart-card">
                            <h3><i class="fas fa-database"></i> Data Management</h3>
                            <div class="form-group">
                                <label>Local Storage</label>
                                <div style="padding: 15px; background: #f8f9fa; border-radius: 10px;">
                                    <div id="storageInfo">Loading storage info...</div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Data Sync</label>
                                <div style="padding: 15px; background: #f8f9fa; border-radius: 10px;">
                                    <div id="syncInfo">Sync status will appear here</div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button class="action-btn secondary" id="clearLocalData">
                                    <i class="fas fa-trash"></i> Clear Local Data
                                </button>
                                <button class="action-btn" id="forceSync">
                                    <i class="fas fa-sync"></i> Force Sync
                                </button>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <h3><i class="fas fa-paint-brush"></i> Appearance</h3>
                            <div class="form-group">
                                <label>Theme Color</label>
                                <div style="display: flex; gap: 10px; margin-top: 10px;">
                                    <div style="width: 40px; height: 40px; background: #4A0072; border-radius: 5px; cursor: pointer; border: 3px solid #4A0072;" data-theme="default"></div>
                                    <div style="width: 40px; height: 40px; background: #2C3E50; border-radius: 5px; cursor: pointer; border: 3px solid #ddd;" data-theme="dark"></div>
                                    <div style="width: 40px; height: 40px; background: #8B0000; border-radius: 5px; cursor: pointer; border: 3px solid #ddd;" data-theme="red"></div>
                                    <div style="width: 40px; height: 40px; background: #006400; border-radius: 5px; cursor: pointer; border: 3px solid #ddd;" data-theme="green"></div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Dashboard Layout</label>
                                <select id="dashboardLayout" class="form-control">
                                    <option value="grid">Grid Layout</option>
                                    <option value="compact">Compact Layout</option>
                                    <option value="detailed">Detailed Layout</option>
                                </select>
                            </div>
                            
                            <button class="action-btn" id="saveSettings">
                                <i class="fas fa-save"></i> Save Settings
                            </button>
                        </div>
                        
                        <div class="chart-card">
                            <h3><i class="fas fa-info-circle"></i> System Information</h3>
                            <div style="padding: 15px; background: #f8f9fa; border-radius: 10px;">
                                <p><strong>System Version:</strong> v1.0.0</p>
                                <p><strong>Last Updated:</strong> 2026</p>
                                <p><strong>Church:</strong> CAC GOOD WORKS ASSEMBLY</p>
                                <p><strong>Pastor:</strong> Pastor AKIN</p>
                                <p><strong>Evangelist:</strong> Bro Moses</p>
                                <p><strong>Total Groups:</strong> 4</p>
                                <p><strong>Total Members:</strong> 60</p>
                                <p><strong>Storage:</strong> <span id="storageUsage">0 KB</span> used</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
        
        <div class="footer">
            <p>Evangelism Tracking System v1.0  CAC GOOD WORKS ASSEMBLY   2026</p>
            <p>Pastor AKIN  Evangelist: Bro Moses  Designed for the Great Commission</p>
            <p style="margin-top: 10px; font-size: 0.8rem;">
                <i class="fas fa-heart" style="color: #dc3545;"></i> 
                "Go therefore and make disciples of all nations" - Matthew 28:19
            </p>
        </div>
    </div>

    <!-- ============================================
         MODALS
         ============================================ -->
    <div class="modal" id="reportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Report Details</h3>
                <button class="close-modal" id="closeReportModal">&times;</button>
            </div>
            <div id="reportModalContent">
                <!-- Report details will be loaded here -->
            </div>
        </div>
    </div>

    <div class="modal" id="followupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Follow-up</h3>
                <button class="close-modal" id="closeFollowupModal">&times;</button>
            </div>
            <form id="followupForm">
                <div class="form-group">
                    <label for="followupPerson">Person Name *</label>
                    <input type="text" id="followupPerson" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="followupContact">Contact Information</label>
                    <input type="text" id="followupContact" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="followupDate">Follow-up Date *</label>
                    <input type="date" id="followupDate" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="followupGroup">Assigned Group</label>
                    <select id="followupGroup" class="form-control">
                        <option value="1">Group 1</option>
                        <option value="2">Group 2</option>
                        <option value="3">Group 3</option>
                        <option value="4">Group 4</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="followupNotes">Notes</label>
                    <textarea id="followupNotes" class="form-control" rows="3"></textarea>
                </div>
                
                <button type="submit" class="action-btn">Save Follow-up</button>
            </form>
        </div>
    </div>

    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Change Password</h3>
                <button class="close-modal" id="closePasswordModal">&times;</button>
            </div>
            <form id="passwordForm">
                <div class="form-group">
                    <label for="currentPassword">Current Password *</label>
                    <input type="password" id="currentPassword" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="newPassword">New Password *</label>
                    <input type="password" id="newPassword" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">Confirm New Password *</label>
                    <input type="password" id="confirmPassword" class="form-control" required>
                </div>
                
                <button type="submit" class="action-btn">Change Password</button>
            </form>
        </div>
    </div>

    <script>
        // ============================================
        // SYSTEM CONFIGURATION & CONSTANTS
        // ============================================
        const SYSTEM_CONFIG = {
            churchName: "CAC GOOD WORKS ASSEMBLY",
            systemName: "Evangelism Tracking & Analytics Dashboard",
            pastor: "Pastor AKIN",
            evangelist: "Bro Moses",
            year: 2026,
            version: "1.0.0"
        };

        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyC8YXzOyvxwOjLXwG9mXgMjpQ-6jKJYFHo",
            authDomain: "cac-good-works.firebaseapp.com",
            projectId: "cac-good-works",
            storageBucket: "cac-good-works.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890"
        };

        // Firebase initialization
        let firebaseApp, auth, db;
        let isOnline = navigator.onLine;
        let useFirebase = false; // Set to true when Firebase is configured
        
        try {
            if (useFirebase && isOnline) {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                console.log("Firebase initialized successfully");
            } else {
                console.log("Running in offline/local mode");
            }
        } catch (error) {
            console.log("Firebase initialization failed, using local storage only");
        }

        // ============================================
        // APPLICATION STATE
        // ============================================
        let currentUser = {
            role: null,
            name: null,
            email: null,
            group: null,
            permissions: []
        };

        let evangelismData = {
            reports: [],
            followups: [],
            groups: [],
            members: [],
            drafts: [],
            settings: {
                theme: 'default',
                layout: 'grid'
            }
        };

        let charts = {
            soulsChart: null,
            activityChart: null,
            participationChart: null,
            conversionsChart: null,
            performanceChart: null,
            monthlyChart: null,
            followupStatusChart: null,
            outreachTypesChart: null
        };

        // ============================================
        // DEFAULT LOGIN CREDENTIALS
        // ============================================
        const DEFAULT_LOGINS = {
            pastor: {
                username: "pastor@cacgoodworks.org",
                password: "Pastor@2026",
                name: "Pastor AKIN",
                role: "pastor",
                permissions: ["all"]
            },
            evangelist: {
                username: "evangelist@cacgoodworks.org",
                password: "Evangelist@2026",
                name: "Bro Moses",
                role: "evangelist",
                permissions: ["create_reports", "view_dashboards", "view_reports", "manage_followups"]
            },
            teamLeaders: {
                "g1leader": {
                    password: "Group1@2026",
                    name: "Dr Mrs Akinbajo",
                    role: "team-leader",
                    group: "1",
                    permissions: ["submit_group_reports", "view_group_history", "view_group_followups"]
                },
                "g2leader": {
                    password: "Group2@2026",
                    name: "Bro Tolu Adesanya",
                    role: "team-leader",
                    group: "2",
                    permissions: ["submit_group_reports", "view_group_history", "view_group_followups"]
                },
                "g3leader": {
                    password: "Group3@2026",
                    name: "Bro Moses Awopeju",
                    role: "team-leader",
                    group: "3",
                    permissions: ["submit_group_reports", "view_group_history", "view_group_followups"]
                },
                "g4leader": {
                    password: "Group4@2026",
                    name: "Bro Korede Towolawi",
                    role: "team-leader",
                    group: "4",
                    permissions: ["submit_group_reports", "view_group_history", "view_group_followups"]
                }
            }
        };

        // ============================================
        // EVANGELISM GROUP DATA
        // ============================================
        const GROUPS_DATA = [
            {
                id: "1",
                name: "Group 1",
                leaders: ["Dr Mrs Akinbajo", "Bro Michael Awopeju"],
                members: [
                    "Mrs Adetayo",
                    "Bro Inioluwa Adetayo",
                    "Sis Oyinkansola Adekoya",
                    "Sis Gboluwaga Ajidagba",
                    "Bro Ireayomide Ajidagba",
                    "Sis Yomi Okunore",
                    "Mrs Quadri",
                    "Mr Michael",
                    "Mrs Michael",
                    "Bro Darasimi Michael",
                    "Mr Adamolekun",
                    "Mrs Adamolekun",
                    "Mrs Ayuba"
                ]
            },
            {
                id: "2",
                name: "Group 2",
                leaders: ["Bro Tolu Adesanya", "Sis Folashade Adegoke"],
                members: [
                    "Mr Gbenga Akinbajo",
                    "Mrs Adeola Akinbajo",
                    "Mrs Soyemi",
                    "Mrs Idowu",
                    "Mrs Olorundipe",
                    "Bro Idowu Taiwo",
                    "Sis Princess Onabule",
                    "Mr Ajao",
                    "Bro Pamilerin Ajao",
                    "Mrs Talabi",
                    "Sis Yemisi Taiwo",
                    "Sis Seun Obajuluwa",
                    "Sis Bisola Ajao"
                ]
            },
            {
                id: "3",
                name: "Group 3",
                leaders: ["Bro Moses Awopeju", "Mrs Ajidagba"],
                members: [
                    "Mr Iruoje",
                    "Sis Kalisha",
                    "Sis Favour Nchieze",
                    "Bro Fidelis",
                    "Sis Aanuoluwapo Adetutu",
                    "Bro Paul Oluwaseun",
                    "Sis Adejoke Chidima",
                    "Bro Adedoyin Adelowo",
                    "Mr Oyeneye",
                    "Mrs Oyeneye",
                    "Sis Deborah Awopeju",
                    "Mrs Okuniyi",
                    "Bro Great Nchieze",
                    "Bro Remi Olayiwola"
                ]
            },
            {
                id: "4",
                name: "Group 4",
                leaders: ["Bro Korede Towolawi", "Elder Obajuluwa", "Bro Abraham Awopeju"],
                members: [
                    "Sis Esther Okuniyi",
                    "Sis Halleluyah Okuniyi",
                    "Miss Kowe",
                    "Sis Tobiloba Ipinlaye",
                    "Mr Odekoya",
                    "Sis Victoria Odekoya",
                    "Sis Opemiolopin Ganiyu",
                    "Mrs Ogungbade",
                    "Sis Comfort Olusina",
                    "Mr Essien",
                    "Sis Dolapo Towolawi",
                    "Bro Ebenezer"
                ]
            }
        ];

        // ============================================
        // INITIALIZATION FUNCTIONS
        // ============================================
        function initApp() {
            // Set today's date as default for date inputs
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportDate').value = today;
            document.getElementById('dateFrom').value = getFirstDayOfMonth();
            document.getElementById('dateTo').value = today;
            document.getElementById('followupDate').value = today;
            
            // Load data from local storage
            loadLocalData();
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize charts
            initCharts();
            
            // Update online status
            updateOnlineStatus();
            
            // Load dashboard data
            loadDashboardData();
            
            // Listen for online/offline events
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            
            // Initialize calendar
            initCalendar();
        }

        function loadLocalData() {
            // Try to load from localStorage
            const savedData = localStorage.getItem('evangelismData');
            if (savedData) {
                evangelismData = JSON.parse(savedData);
                console.log('Loaded data from local storage:', evangelismData.reports.length, 'reports');
            } else {
                // Initialize with sample data for demo
                evangelismData = {
                    reports: generateSampleReports(),
                    followups: generateSampleFollowups(),
                    groups: GROUPS_DATA,
                    members: getAllMembers(),
                    drafts: [],
                    settings: {
                        theme: 'default',
                        layout: 'grid'
                    }
                };
                saveLocalData();
            }
        }

        function saveLocalData() {
            localStorage.setItem('evangelismData', JSON.stringify(evangelismData));
            updateStorageInfo();
            console.log('Data saved to local storage');
        }

        function generateSampleReports() {
            const sampleReports = [];
            const locations = ["Oke-Afa Community", "Ijegun Area", "Ikotun Market", "Egbeda Housing Estate", "Igando Community"];
            const reportTypes = ["outreach", "followup", "training"];
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 60);
            
            for (let i = 1; i <= 20; i++) {
                const reportDate = new Date(startDate);
                reportDate.setDate(startDate.getDate() + Math.floor(Math.random() * 60));
                
                const groupId = Math.floor(Math.random() * 4) + 1;
                const group = GROUPS_DATA.find(g => g.id === groupId.toString());
                const participantsCount = Math.floor(Math.random() * 5) + 3;
                const participants = group.members.slice(0, participantsCount);
                const reportType = reportTypes[Math.floor(Math.random() * reportTypes.length)];
                
                sampleReports.push({
                    id: `report-${Date.now()}-${i}`,
                    date: reportDate.toISOString().split('T')[0],
                    location: locations[Math.floor(Math.random() * locations.length)],
                    group: groupId.toString(),
                    teamLeader: group.leaders[0],
                    participants: participants,
                    totalReached: Math.floor(Math.random() * 50) + 20,
                    soulsWon: Math.floor(Math.random() * 15) + 5,
                    followups: Math.floor(Math.random() * 10) + 1,
                    reportType: reportType,
                    testimonies: "We encountered open hearts and many were willing to listen to the gospel message. Several people gave their lives to Christ.",
                    challenges: "Some resistance from traditional religious practitioners. Weather conditions were challenging.",
                    recommendations: "Need more follow-up visits to new converts. Consider evening evangelism for working class.",
                    submittedBy: Math.random() > 0.5 ? "Pastor AKIN" : "Bro Moses",
                    timestamp: reportDate.toISOString()
                });
            }
            
            return sampleReports;
        }

        function generateSampleFollowups() {
            const sampleFollowups = [];
            const names = ["Brother John", "Sister Mary", "Brother David", "Sister Grace", "Brother Samuel", "Sister Ruth"];
            const statuses = ["pending", "completed", "overdue"];
            
            for (let i = 1; i <= 8; i++) {
                const followupDate = new Date();
                followupDate.setDate(followupDate.getDate() + Math.floor(Math.random() * 30) - 15);
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                
                sampleFollowups.push({
                    id: `followup-${Date.now()}-${i}`,
                    person: names[Math.floor(Math.random() * names.length)],
                    contact: "Phone: 080" + Math.floor(Math.random() * 90000000 + 10000000),
                    date: followupDate.toISOString().split('T')[0],
                    group: (Math.floor(Math.random() * 4) + 1).toString(),
                    notes: "Needs discipleship materials. Interested in home fellowship.",
                    status: status,
                    assignedTo: GROUPS_DATA[Math.floor(Math.random() * 4)].leaders[0],
                    createdAt: new Date().toISOString()
                });
            }
            
            return sampleFollowups;
        }

        function getAllMembers() {
            const allMembers = [];
            GROUPS_DATA.forEach(group => {
                group.members.forEach(member => {
                    if (!allMembers.includes(member)) {
                        allMembers.push(member);
                    }
                });
            });
            return allMembers;
        }

        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================
        function setupLoginListeners() {
            document.querySelectorAll('.role-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.role-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    
                    const role = this.getAttribute('data-role');
                    const groupSelection = document.getElementById('groupSelection');
                    
                    if (role === 'team-leader') {
                        groupSelection.style.display = 'block';
                    } else {
                        groupSelection.style.display = 'none';
                    }
                });
            });
            
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        }

        function handleLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const selectedRole = document.querySelector('.role-option.selected')?.getAttribute('data-role');
            const group = document.getElementById('group')?.value;
            
            if (!selectedRole) {
                showNotification('Please select a role', 'warning');
                return;
            }
            
            if (!username || !password) {
                showNotification('Please enter username and password', 'warning');
                return;
            }
            
            if (selectedRole === 'team-leader' && !group) {
                showNotification('Please select your group', 'warning');
                return;
            }
            
            let authenticated = false;
            
            // Check against default logins
            if (selectedRole === 'pastor') {
                if (username === DEFAULT_LOGINS.pastor.username && password === DEFAULT_LOGINS.pastor.password) {
                    currentUser = {
                        ...DEFAULT_LOGINS.pastor,
                        email: username
                    };
                    authenticated = true;
                }
            } else if (selectedRole === 'evangelist') {
                if (username === DEFAULT_LOGINS.evangelist.username && password === DEFAULT_LOGINS.evangelist.password) {
                    currentUser = {
                        ...DEFAULT_LOGINS.evangelist,
                        email: username
                    };
                    authenticated = true;
                }
            } else if (selectedRole === 'team-leader') {
                const teamLeader = DEFAULT_LOGINS.teamLeaders[username];
                if (teamLeader && teamLeader.password === password && teamLeader.group === group) {
                    currentUser = {
                        ...teamLeader,
                        username: username,
                        email: `${username}@cacgoodworks.org`
                    };
                    authenticated = true;
                }
            } else if (selectedRole === 'guest') {
                currentUser = {
                    role: 'guest',
                    name: 'Guest User',
                    email: 'guest@cacgoodworks.org',
                    permissions: ['view_dashboards', 'view_reports']
                };
                authenticated = true;
            }
            
            if (authenticated) {
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                document.getElementById('mainContent').style.display = 'grid';
                
                updateUserInterface();
                initApp();
                
                showNotification(`Welcome, ${currentUser.name}!`, 'success');
            } else {
                showNotification('Invalid login credentials. Please try again.', 'error');
            }
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = {
                    role: null,
                    name: null,
                    email: null,
                    group: null,
                    permissions: []
                };
                
                localStorage.removeItem('currentUser');
                
                document.querySelectorAll('.role-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('groupSelection').style.display = 'none';
                
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('appContainer').style.display = 'none';
                
                showNotification('Logged out successfully', 'info');
            }
        }

        function updateUserInterface() {
            document.getElementById('currentUserName').textContent = currentUser.name;
            document.getElementById('currentUserRole').textContent = currentUser.role.toUpperCase();
            document.getElementById('currentRoleDisplay').textContent = currentUser.role.toUpperCase();
            
            const userIcon = document.getElementById('userIcon');
            if (currentUser.role === 'pastor') {
                userIcon.className = 'fas fa-user-shield';
            } else if (currentUser.role === 'evangelist') {
                userIcon.className = 'fas fa-cross';
            } else if (currentUser.role === 'team-leader') {
                userIcon.className = 'fas fa-users';
            } else {
                userIcon.className = 'fas fa-user-circle';
            }
            
            const groupElement = document.getElementById('currentUserGroup');
            if (currentUser.group) {
                groupElement.textContent = `Group ${currentUser.group} Leader`;
                groupElement.className = `group-badge group-${currentUser.group}`;
                groupElement.style.display = 'inline-block';
            } else {
                groupElement.style.display = 'none';
            }
            
            updatePermissionsDisplay();
            adjustUIBasedOnPermissions();
        }

        function updatePermissionsDisplay() {
            const permissionsList = document.getElementById('permissionsList');
            permissionsList.innerHTML = '';
            
            if (currentUser.permissions.includes('all')) {
                permissionsList.innerHTML = '<p>Full system access</p>';
            } else {
                const permissionMap = {
                    'create_reports': 'Create evangelism reports',
                    'view_dashboards': 'View dashboards',
                    'view_reports': 'View all reports',
                    'submit_group_reports': 'Submit group reports',
                    'view_group_history': 'View group history',
                    'manage_followups': 'Manage follow-ups',
                    'view_group_followups': 'View group follow-ups'
                };
                
                currentUser.permissions.forEach(perm => {
                    if (permissionMap[perm]) {
                        const permItem = document.createElement('p');
                        permItem.innerHTML = `<i class="fas fa-check-circle" style="color: #28a745;"></i> ${permissionMap[perm]}`;
                        permissionsList.appendChild(permItem);
                    }
                });
            }
        }

        function adjustUIBasedOnPermissions() {
            const navLinks = document.querySelectorAll('.nav-link');
            
            navLinks.forEach(link => {
                const page = link.getAttribute('data-page');
                
                if (currentUser.role === 'team-leader') {
                    if (!['dashboard', 'new-report', 'followups', 'groups'].includes(page)) {
                        link.style.display = 'none';
                    }
                }
                
                if (currentUser.role === 'guest') {
                    if (!['dashboard', 'reports', 'groups'].includes(page)) {
                        link.style.display = 'none';
                    }
                }
            });
            
            // Disable export for guests and team leaders
            if (currentUser.role === 'guest' || currentUser.role === 'team-leader') {
                document.querySelectorAll('.export-card').forEach(card => {
                    card.style.opacity = '0.5';
                    card.style.cursor = 'not-allowed';
                    card.onclick = null;
                });
            }
        }

        // ============================================
        // EVENT LISTENERS SETUP
        // ============================================
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    document.querySelectorAll('.nav-link').forEach(l => {
                        l.classList.remove('active');
                    });
                    
                    this.classList.add('active');
                    
                    document.querySelectorAll('.page').forEach(page => {
                        page.classList.remove('active');
                    });
                    
                    const pageId = this.getAttribute('data-page');
                    document.getElementById(`${pageId}-page`).classList.add('active');
                    
                    // Load page-specific data
                    switch(pageId) {
                        case 'dashboard':
                            loadDashboardData();
                            break;
                        case 'reports':
                            loadReportsTable();
                            break;
                        case 'followups':
                            loadFollowups();
                            break;
                        case 'groups':
                            loadGroupsPage();
                            break;
                        case 'analytics':
                            loadAnalyticsPage();
                            break;
                        case 'settings':
                            loadSettingsPage();
                            break;
                    }
                });
            });
            
            // Report form
            document.getElementById('reportForm').addEventListener('submit', handleReportSubmit);
            document.getElementById('clearFormBtn').addEventListener('click', clearReportForm);
            document.getElementById('saveDraftBtn').addEventListener('click', saveReportDraft);
            document.getElementById('loadDraftBtn').addEventListener('click', loadReportDraft);
            document.getElementById('groupNumber').addEventListener('change', updateTeamLeaderAndMembers);
            
            // Dashboard filters
            document.getElementById('applyFilter').addEventListener('click', loadDashboardData);
            document.getElementById('resetFilter').addEventListener('click', resetDashboardFilters);
            
            // Reports
            document.getElementById('searchReports').addEventListener('click', loadReportsTable);
            document.getElementById('prevPage').addEventListener('click', previousReportsPage);
            document.getElementById('nextPage').addEventListener('click', nextReportsPage);
            
            // Follow-ups
            document.getElementById('addFollowupBtn').addEventListener('click', showFollowupModal);
            document.getElementById('markCompletedBtn').addEventListener('click', markFollowupsCompleted);
            document.getElementById('refreshFollowups').addEventListener('click', loadFollowups);
            document.getElementById('closeFollowupModal').addEventListener('click', hideFollowupModal);
            document.getElementById('followupForm').addEventListener('submit', handleFollowupSubmit);
            
            // Groups
            document.getElementById('refreshGroupsBtn').addEventListener('click', loadGroupsPage);
            
            // Calendar
            document.getElementById('addEventBtn').addEventListener('click', addCalendarEvent);
            document.getElementById('todayBtn').addEventListener('click', goToToday);
            
            // Analytics
            document.getElementById('refreshAnalytics').addEventListener('click', loadAnalyticsPage);
            
            // Export
            document.getElementById('exportPDF').addEventListener('click', exportToPDF);
            document.getElementById('exportExcel').addEventListener('click', exportToExcel);
            document.getElementById('exportJSON').addEventListener('click', exportToJSON);
            document.getElementById('exportPrint').addEventListener('click', exportToPrint);
            document.getElementById('generateExport').addEventListener('click', generateCustomExport);
            document.getElementById('previewExport').addEventListener('click', previewExport);
            
            // Settings
            document.getElementById('changePasswordBtn').addEventListener('click', showPasswordModal);
            document.getElementById('clearLocalData').addEventListener('click', clearLocalData);
            document.getElementById('forceSync').addEventListener('click', forceSync);
            document.getElementById('saveSettings').addEventListener('click', saveSettings);
            document.getElementById('closePasswordModal').addEventListener('click', hidePasswordModal);
            document.getElementById('passwordForm').addEventListener('submit', handlePasswordChange);
            
            // Modals
            document.getElementById('closeReportModal').addEventListener('click', hideReportModal);
            
            // Theme selection
            document.querySelectorAll('[data-theme]').forEach(themeBtn => {
                themeBtn.addEventListener('click', function() {
                    document.querySelectorAll('[data-theme]').forEach(btn => {
                        btn.style.borderColor = '#ddd';
                    });
                    this.style.borderColor = this.style.backgroundColor;
                    evangelismData.settings.theme = this.getAttribute('data-theme');
                });
            });
            
            // Check for saved draft
            checkForSavedDraft();
        }

        // ============================================
        // REPORT MANAGEMENT FUNCTIONS
        // ============================================
        function updateTeamLeaderAndMembers() {
            const groupNumber = document.getElementById('groupNumber').value;
            if (!groupNumber) return;
            
            const group = GROUPS_DATA.find(g => g.id === groupNumber);
            if (group) {
                document.getElementById('teamLeader').value = group.leaders[0];
                
                const checklist = document.getElementById('membersChecklist');
                checklist.innerHTML = '';
                
                group.members.forEach(member => {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'member-item';
                    memberItem.innerHTML = `
                        <input type="checkbox" id="member-${member.replace(/\s+/g, '-')}" value="${member}">
                        <label for="member-${member.replace(/\s+/g, '-')}">${member}</label>
                    `;
                    checklist.appendChild(memberItem);
                });
            }
        }

        function handleReportSubmit(e) {
            e.preventDefault();
            
            const formData = {
                id: 'report-' + Date.now(),
                date: document.getElementById('reportDate').value,
                location: document.getElementById('location').value,
                group: document.getElementById('groupNumber').value,
                teamLeader: document.getElementById('teamLeader').value,
                participants: Array.from(document.querySelectorAll('#membersChecklist input:checked')).map(cb => cb.value),
                totalReached: parseInt(document.getElementById('totalReached').value),
                soulsWon: parseInt(document.getElementById('soulsWon').value),
                followups: parseInt(document.getElementById('followups').value) || 0,
                reportType: document.querySelector('input[name="reportType"]:checked').value,
                testimonies: document.getElementById('testimonies').value,
                challenges: document.getElementById('challenges').value,
                recommendations: document.getElementById('recommendations').value,
                submittedBy: currentUser.name,
                timestamp: new Date().toISOString()
            };
            
            if (!formData.participants.length) {
                showNotification('Please select at least one participant', 'warning');
                return;
            }
            
            evangelismData.reports.push(formData);
            saveLocalData();
            
            if (isOnline && useFirebase && db) {
                syncReportToFirebase(formData);
            }
            
            showNotification('Evangelism report submitted successfully!', 'success');
            clearReportForm();
            loadDashboardData();
            
            document.querySelector('.nav-link[data-page="reports"]').click();
        }

        function clearReportForm() {
            document.getElementById('reportForm').reset();
            document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('teamLeader').value = '';
            document.getElementById('membersChecklist').innerHTML = '';
            document.querySelector('input[name="reportType"][value="outreach"]').checked = true;
            
            localStorage.removeItem('reportDraft');
            showNotification('Form cleared', 'info');
        }

        function saveReportDraft() {
            const formData = {
                date: document.getElementById('reportDate').value,
                location: document.getElementById('location').value,
                group: document.getElementById('groupNumber').value,
                teamLeader: document.getElementById('teamLeader').value,
                participants: Array.from(document.querySelectorAll('#membersChecklist input:checked')).map(cb => cb.value),
                totalReached: document.getElementById('totalReached').value,
                soulsWon: document.getElementById('soulsWon').value,
                followups: document.getElementById('followups').value,
                reportType: document.querySelector('input[name="reportType"]:checked').value,
                testimonies: document.getElementById('testimonies').value,
                challenges: document.getElementById('challenges').value,
                recommendations: document.getElementById('recommendations').value
            };
            
            localStorage.setItem('reportDraft', JSON.stringify(formData));
            showNotification('Draft saved locally', 'info');
        }

        function loadReportDraft() {
            const savedDraft = localStorage.getItem('reportDraft');
            if (!savedDraft) {
                showNotification('No saved draft found', 'warning');
                return;
            }
            
            if (confirm('Load saved draft? This will replace current form data.')) {
                const draft = JSON.parse(savedDraft);
                
                document.getElementById('reportDate').value = draft.date;
                document.getElementById('location').value = draft.location;
                document.getElementById('groupNumber').value = draft.group;
                
                document.getElementById('groupNumber').dispatchEvent(new Event('change'));
                
                setTimeout(() => {
                    document.getElementById('teamLeader').value = draft.teamLeader;
                    document.getElementById('totalReached').value = draft.totalReached;
                    document.getElementById('soulsWon').value = draft.soulsWon;
                    document.getElementById('followups').value = draft.followups;
                    
                    if (draft.reportType) {
                        document.querySelector(`input[name="reportType"][value="${draft.reportType}"]`).checked = true;
                    }
                    
                    document.getElementById('testimonies').value = draft.testimonies || '';
                    document.getElementById('challenges').value = draft.challenges || '';
                    document.getElementById('recommendations').value = draft.recommendations || '';
                    
                    if (draft.participants && draft.participants.length) {
                        draft.participants.forEach(participant => {
                            const checkbox = document.querySelector(`#membersChecklist input[value="${participant}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                            }
                        });
                    }
                    
                    showNotification('Draft loaded successfully', 'success');
                }, 500);
            }
        }

        function checkForSavedDraft() {
            if (localStorage.getItem('reportDraft')) {
                document.getElementById('loadDraftBtn').style.display = 'flex';
            }
        }

        function syncReportToFirebase(report) {
            if (!db) return;
            
            db.collection('evangelismReports').add(report)
                .then(() => {
                    console.log('Report synced to Firebase');
                })
                .catch(error => {
                    console.error('Error syncing to Firebase:', error);
                });
        }

        // ============================================
        // DASHBOARD FUNCTIONS
        // ============================================
        function loadDashboardData() {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const groupFilter = document.getElementById('groupFilter').value;
            
            let filteredReports = evangelismData.reports;
            
            if (dateFrom) {
                filteredReports = filteredReports.filter(report => report.date >= dateFrom);
            }
            
            if (dateTo) {
                filteredReports = filteredReports.filter(report => report.date <= dateTo);
            }
            
            if (groupFilter !== 'all') {
                filteredReports = filteredReports.filter(report => report.group === groupFilter);
            }
            
            if (currentUser.role === 'team-leader' && currentUser.group) {
                filteredReports = filteredReports.filter(report => report.group === currentUser.group);
            }
            
            // Calculate statistics
            const totalSouls = filteredReports.reduce((sum, report) => sum + report.soulsWon, 0);
            const totalReports = filteredReports.length;
            const totalParticipants = filteredReports.reduce((sum, report) => sum + report.participants.length, 0);
            const totalFollowups = filteredReports.reduce((sum, report) => sum + (report.followups || 0), 0);
            const totalGroups = 4;
            
            const totalReached = filteredReports.reduce((sum, report) => sum + report.totalReached, 0);
            const conversionRate = totalReached > 0 ? ((totalSouls / totalReached) * 100).toFixed(1) : 0;
            
            // Update stats cards
            document.getElementById('totalSouls').textContent = totalSouls;
            document.getElementById('totalReports').textContent = totalReports;
            document.getElementById('totalParticipants').textContent = totalParticipants;
            document.getElementById('totalFollowups').textContent = totalFollowups;
            document.getElementById('totalGroups').textContent = totalGroups;
            document.getElementById('conversionRate').textContent = `${conversionRate}%`;
            
            // Calculate changes (simulated)
            const lastMonthSouls = Math.floor(totalSouls * 0.8);
            const soulsChange = totalSouls - lastMonthSouls;
            document.getElementById('soulsChange').textContent = `${soulsChange >= 0 ? '+' : ''}${soulsChange} this month`;
            document.getElementById('soulsChange').className = soulsChange >= 0 ? 'positive' : 'negative';
            
            // Update charts
            updateCharts(filteredReports);
            updateTopPerformers(filteredReports);
        }

        function resetDashboardFilters() {
            document.getElementById('dateFrom').value = getFirstDayOfMonth();
            document.getElementById('dateTo').value = new Date().toISOString().split('T')[0];
            document.getElementById('groupFilter').value = 'all';
            loadDashboardData();
        }

        function initCharts() {
            const ctx1 = document.getElementById('soulsChart').getContext('2d');
            charts.soulsChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Group 1', 'Group 2', 'Group 3', 'Group 4'],
                    datasets: [{
                        label: 'Souls Won',
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(74, 0, 114, 0.7)',
                            'rgba(138, 43, 226, 0.7)',
                            'rgba(255, 215, 0, 0.7)',
                            'rgba(156, 39, 176, 0.7)'
                        ],
                        borderColor: [
                            'rgb(74, 0, 114)',
                            'rgb(138, 43, 226)',
                            'rgb(255, 215, 0)',
                            'rgb(156, 39, 176)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Souls: ${context.raw}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Souls'
                            }
                        }
                    }
                }
            });
            
            const ctx2 = document.getElementById('activityChart').getContext('2d');
            charts.activityChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Evangelism Activities',
                        data: [],
                        borderColor: 'rgb(74, 0, 114)',
                        backgroundColor: 'rgba(74, 0, 114, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Activities: ${context.raw}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Activities'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    }
                }
            });
            
            const ctx3 = document.getElementById('participationChart').getContext('2d');
            charts.participationChart = new Chart(ctx3, {
                type: 'pie',
                data: {
                    labels: ['Group 1', 'Group 2', 'Group 3', 'Group 4'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(74, 0, 114, 0.7)',
                            'rgba(138, 43, 226, 0.7)',
                            'rgba(255, 215, 0, 0.7)',
                            'rgba(156, 39, 176, 0.7)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value} participants (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            const ctx4 = document.getElementById('conversionsChart').getContext('2d');
            charts.conversionsChart = new Chart(ctx4, {
                type: 'doughnut',
                data: {
                    labels: ['Conversions', 'Follow-ups Required'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: [
                            'rgba(76, 175, 80, 0.7)',
                            'rgba(255, 152, 0, 0.7)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.raw}`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Initialize other charts for analytics page
            const ctx5 = document.getElementById('performanceChart').getContext('2d');
            charts.performanceChart = new Chart(ctx5, {
                type: 'radar',
                data: {
                    labels: ['Souls Won', 'Participation', 'Follow-ups', 'Locations', 'Testimonies'],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
            
            const ctx6 = document.getElementById('monthlyChart').getContext('2d');
            charts.monthlyChart = new Chart(ctx6, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
            const ctx7 = document.getElementById('followupStatusChart').getContext('2d');
            charts.followupStatusChart = new Chart(ctx7, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'Pending', 'Overdue'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            'rgba(76, 175, 80, 0.7)',
                            'rgba(255, 152, 0, 0.7)',
                            'rgba(244, 67, 54, 0.7)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
            const ctx8 = document.getElementById('outreachTypesChart').getContext('2d');
            charts.outreachTypesChart = new Chart(ctx8, {
                type: 'bar',
                data: {
                    labels: ['Outreach', 'Follow-up', 'Training'],
                    datasets: [{
                        label: 'Activity Count',
                        data: [0, 0, 0],
                        backgroundColor: [
                            'rgba(74, 0, 114, 0.7)',
                            'rgba(138, 43, 226, 0.7)',
                            'rgba(255, 215, 0, 0.7)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function updateCharts(reports) {
            // Update Souls Won chart
            const groupSouls = [0, 0, 0, 0];
            reports.forEach(report => {
                const groupIndex = parseInt(report.group) - 1;
                if (groupIndex >= 0 && groupIndex < 4) {
                    groupSouls[groupIndex] += report.soulsWon;
                }
            });
            charts.soulsChart.data.datasets[0].data = groupSouls;
            charts.soulsChart.update();
            
            // Update Activity chart (last 14 days)
            const last14Days = [];
            for (let i = 13; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                last14Days.push(date.toISOString().split('T')[0]);
            }
            
            const dailyActivity = last14Days.map(date => {
                return reports.filter(report => report.date === date).length;
            });
            
            charts.activityChart.data.labels = last14Days.map(date => formatDate(date, true));
            charts.activityChart.data.datasets[0].data = dailyActivity;
            charts.activityChart.update();
            
            // Update Participation chart
            const groupParticipation = [0, 0, 0, 0];
            reports.forEach(report => {
                const groupIndex = parseInt(report.group) - 1;
                if (groupIndex >= 0 && groupIndex < 4) {
                    groupParticipation[groupIndex] += report.participants.length;
                }
            });
            charts.participationChart.data.datasets[0].data = groupParticipation;
            charts.participationChart.update();
            
            // Update Conversions vs Follow-ups chart
            const totalSouls = reports.reduce((sum, report) => sum + report.soulsWon, 0);
            const totalFollowups = reports.reduce((sum, report) => sum + (report.followups || 0), 0);
            charts.conversionsChart.data.datasets[0].data = [totalSouls, totalFollowups];
            charts.conversionsChart.update();
        }

        function updateTopPerformers(reports) {
            const performersContainer = document.getElementById('topPerformers');
            performersContainer.innerHTML = '';
            
            // Count participation
            const participationCount = {};
            reports.forEach(report => {
                report.participants.forEach(participant => {
                    participationCount[participant] = (participationCount[participant] || 0) + 1;
                });
            });
            
            // Sort by participation count
            const topParticipants = Object.entries(participationCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 4);
            
            topParticipants.forEach(([participant, count], index) => {
                const performerCard = document.createElement('div');
                performerCard.className = 'stat-card';
                performerCard.style.flexDirection = 'column';
                performerCard.style.textAlign = 'center';
                performerCard.style.padding = '20px';
                
                const rankColors = ['#FFD700', '#C0C0C0', '#CD7F32', '#4A0072'];
                const rankIcons = ['', '', '', ''];
                
                performerCard.innerHTML = `
                    <div style="font-size: 2.5rem; margin-bottom: 10px;">${rankIcons[index]}</div>
                    <div style="font-size: 1.2rem; font-weight: bold; color: ${rankColors[index]};">${participant}</div>
                    <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">${count} outreaches</div>
                    <div style="margin-top: 5px; font-size: 0.8rem; color: #999;">Most Active Participant</div>
                `;
                
                performersContainer.appendChild(performerCard);
            });
        }

        // ============================================
        // REPORTS TABLE FUNCTIONS
        // ============================================
        let currentPage = 1;
        const itemsPerPage = 10;

        function loadReportsTable() {
            const groupFilter = document.getElementById('reportGroupFilter').value;
            const typeFilter = document.getElementById('reportTypeFilter').value;
            const dateFilter = document.getElementById('reportDateFilter').value;
            
            let filteredReports = evangelismData.reports;
            
            if (groupFilter !== 'all') {
                filteredReports = filteredReports.filter(report => report.group === groupFilter);
            }
            
            if (typeFilter !== 'all') {
                filteredReports = filteredReports.filter(report => report.reportType === typeFilter);
            }
            
            if (dateFilter) {
                filteredReports = filteredReports.filter(report => report.date === dateFilter);
            }
            
            if (currentUser.role === 'team-leader' && currentUser.group) {
                filteredReports = filteredReports.filter(report => report.group === currentUser.group);
            }
            
            // Sort by date (newest first)
            filteredReports.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const totalPages = Math.ceil(filteredReports.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageReports = filteredReports.slice(startIndex, endIndex);
            
            // Populate table
            const tableBody = document.getElementById('reportsTableBody');
            tableBody.innerHTML = '';
            
            pageReports.forEach(report => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(report.date)}</td>
                    <td><span class="group-badge group-${report.group}">Group ${report.group}</span></td>
                    <td>${report.location}</td>
                    <td><span class="group-badge" style="background: #e3f2fd; color: #1565c0;">${report.reportType}</span></td>
                    <td>${report.participants.length}</td>
                    <td>${report.totalReached}</td>
                    <td><strong style="color: #4CAF50;">${report.soulsWon}</strong></td>
                    <td class="actions">
                        <button class="action-btn view-report-btn" data-id="${report.id}" style="padding: 5px 10px; font-size: 0.9rem;">
                            <i class="fas fa-eye"></i> View
                        </button>
                        ${currentUser.role === 'pastor' ? `
                        <button class="action-btn danger delete-report-btn" data-id="${report.id}" style="padding: 5px 10px; font-size: 0.9rem;">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Update pagination
            document.getElementById('reportsCount').textContent = `${filteredReports.length} reports found`;
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
            
            // Update button states
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
            
            // Add event listeners
            document.querySelectorAll('.view-report-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const reportId = this.getAttribute('data-id');
                    showReportDetails(reportId);
                });
            });
            
            document.querySelectorAll('.delete-report-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const reportId = this.getAttribute('data-id');
                    deleteReport(reportId);
                });
            });
        }

        function previousReportsPage() {
            if (currentPage > 1) {
                currentPage--;
                loadReportsTable();
            }
        }

        function nextReportsPage() {
            const totalPages = Math.ceil(evangelismData.reports.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                loadReportsTable();
            }
        }

        function showReportDetails(reportId) {
            const report = evangelismData.reports.find(r => r.id === reportId);
            if (!report) return;
            
            const modalContent = document.getElementById('reportModalContent');
            modalContent.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--primary); margin-bottom: 15px;">Report Details</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <p><strong>Date:</strong> ${formatDate(report.date)}</p>
                            <p><strong>Location:</strong> ${report.location}</p>
                            <p><strong>Group:</strong> <span class="group-badge group-${report.group}">Group ${report.group}</span></p>
                            <p><strong>Type:</strong> ${report.reportType}</p>
                        </div>
                        <div>
                            <p><strong>Team Leader:</strong> ${report.teamLeader}</p>
                            <p><strong>Total Reached:</strong> ${report.totalReached}</p>
                            <p><strong>Souls Won:</strong> <span style="color: #4CAF50; font-weight: bold;">${report.soulsWon}</span></p>
                            <p><strong>Follow-ups Required:</strong> ${report.followups}</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <strong>Participants (${report.participants.length}):</strong>
                        <div style="margin-top: 5px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            ${report.participants.join(', ')}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <strong>Testimonies / Observations:</strong>
                        <div style="margin-top: 5px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            ${report.testimonies || 'None recorded'}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <strong>Challenges Encountered:</strong>
                        <div style="margin-top: 5px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            ${report.challenges || 'None recorded'}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <strong>Recommendations:</strong>
                        <div style="margin-top: 5px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            ${report.recommendations || 'None recorded'}
                        </div>
                    </div>
                    
                    <div style="border-top: 1px solid #eee; padding-top: 15px; font-size: 0.9rem; color: #666;">
                        <p><strong>Submitted By:</strong> ${report.submittedBy}</p>
                        <p><strong>Submitted On:</strong> ${formatDate(report.timestamp.split('T')[0])} at ${new Date(report.timestamp).toLocaleTimeString()}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('reportModal').style.display = 'flex';
        }

        function hideReportModal() {
            document.getElementById('reportModal').style.display = 'none';
        }

        function deleteReport(reportId) {
            if (confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
                evangelismData.reports = evangelismData.reports.filter(r => r.id !== reportId);
                saveLocalData();
                loadReportsTable();
                loadDashboardData();
                showNotification('Report deleted successfully', 'success');
            }
        }

        // ============================================
        // FOLLOW-UPS FUNCTIONS
        // ============================================
        function loadFollowups() {
            const statusFilter = document.getElementById('followupStatusFilter').value;
            const groupFilter = document.getElementById('followupGroupFilter').value;
            
            let filteredFollowups = evangelismData.followups;
            
            if (statusFilter !== 'all') {
                filteredFollowups = filteredFollowups.filter(f => f.status === statusFilter);
            }
            
            if (groupFilter !== 'all') {
                filteredFollowups = filteredFollowups.filter(f => f.group === groupFilter);
            }
            
            if (currentUser.role === 'team-leader' && currentUser.group) {
                filteredFollowups = filteredFollowups.filter(f => f.group === currentUser.group);
            }
            
            const container = document.getElementById('followupContainer');
            container.innerHTML = '';
            
            if (filteredFollowups.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; background: white; border-radius: var(--radius);">
                        <i class="fas fa-inbox" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                        <h3 style="color: #666;">No Follow-ups Found</h3>
                        <p>Click "Add Follow-up" to create new follow-up records.</p>
                    </div>
                `;
                return;
            }
            
            filteredFollowups.forEach(followup => {
                const followupCard = document.createElement('div');
                followupCard.className = `followup-card ${followup.status}`;
                
                const statusText = followup.status.charAt(0).toUpperCase() + followup.status.slice(1);
                const statusClass = `status-${followup.status}`;
                
                followupCard.innerHTML = `
                    <div class="followup-header">
                        <h4 style="margin: 0;">${followup.person}</h4>
                        <span class="followup-status ${statusClass}">${statusText}</span>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <p><strong>Contact:</strong> ${followup.contact || 'Not specified'}</p>
                        <p><strong>Date:</strong> ${formatDate(followup.date)}</p>
                        <p><strong>Group:</strong> <span class="group-badge group-${followup.group}">Group ${followup.group}</span></p>
                        <p><strong>Assigned to:</strong> ${followup.assignedTo}</p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>Notes:</strong>
                        <p style="margin-top: 5px; font-size: 0.9rem;">${followup.notes || 'No notes'}</p>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: space-between;">
                        <button class="action-btn success mark-followup-btn" data-id="${followup.id}" style="flex: 1; padding: 8px;">
                            <i class="fas fa-check"></i> Mark Done
                        </button>
                        <button class="action-btn edit-followup-btn" data-id="${followup.id}" style="flex: 1; padding: 8px;">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        ${currentUser.role === 'pastor' ? `
                        <button class="action-btn danger delete-followup-btn" data-id="${followup.id}" style="padding: 8px;">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </div>
                `;
                
                container.appendChild(followupCard);
            });
            
            // Add event listeners
            document.querySelectorAll('.mark-followup-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const followupId = this.getAttribute('data-id');
                    markFollowupCompleted(followupId);
                });
            });
            
            document.querySelectorAll('.edit-followup-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const followupId = this.getAttribute('data-id');
                    editFollowup(followupId);
                });
            });
            
            document.querySelectorAll('.delete-followup-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const followupId = this.getAttribute('data-id');
                    deleteFollowup(followupId);
                });
            });
        }

        function showFollowupModal() {
            document.getElementById('followupModal').style.display = 'flex';
        }

        function hideFollowupModal() {
            document.getElementById('followupModal').style.display = 'none';
            document.getElementById('followupForm').reset();
        }

        function handleFollowupSubmit(e) {
            e.preventDefault();
            
            const formData = {
                id: 'followup-' + Date.now(),
                person: document.getElementById('followupPerson').value,
                contact: document.getElementById('followupContact').value,
                date: document.getElementById('followupDate').value,
                group: document.getElementById('followupGroup').value,
                notes: document.getElementById('followupNotes').value,
                status: 'pending',
                assignedTo: GROUPS_DATA.find(g => g.id === document.getElementById('followupGroup').value).leaders[0],
                createdAt: new Date().toISOString()
            };
            
            evangelismData.followups.push(formData);
            saveLocalData();
            loadFollowups();
            hideFollowupModal();
            
            showNotification('Follow-up added successfully', 'success');
        }

        function markFollowupCompleted(followupId) {
            const followup = evangelismData.followups.find(f => f.id === followupId);
            if (followup) {
                followup.status = 'completed';
                saveLocalData();
                loadFollowups();
                showNotification('Follow-up marked as completed', 'success');
            }
        }

        function markFollowupsCompleted() {
            const selectedFollowups = evangelismData.followups.filter(f => f.status === 'pending');
            
            if (selectedFollowups.length === 0) {
                showNotification('No pending follow-ups to mark as completed', 'warning');
                return;
            }
            
            if (confirm(`Mark all ${selectedFollowups.length} pending follow-ups as completed?`)) {
                selectedFollowups.forEach(followup => {
                    followup.status = 'completed';
                });
                
                saveLocalData();
                loadFollowups();
                showNotification(`${selectedFollowups.length} follow-ups marked as completed`, 'success');
            }
        }

        function editFollowup(followupId) {
            // For simplicity, we'll just mark as completed
            markFollowupCompleted(followupId);
        }

        function deleteFollowup(followupId) {
            if (confirm('Are you sure you want to delete this follow-up?')) {
                evangelismData.followups = evangelismData.followups.filter(f => f.id !== followupId);
                saveLocalData();
                loadFollowups();
                showNotification('Follow-up deleted successfully', 'success');
            }
        }

        // ============================================
        // GROUPS PAGE FUNCTIONS
        // ============================================
        function loadGroupsPage() {
            const groupsContainer = document.getElementById('groupsContainer');
            groupsContainer.innerHTML = '';
            
            GROUPS_DATA.forEach(group => {
                if (currentUser.role === 'team-leader' && currentUser.group !== group.id) {
                    return;
                }
                
                const groupReports = evangelismData.reports.filter(r => r.group === group.id);
                const totalSouls = groupReports.reduce((sum, report) => sum + report.soulsWon, 0);
                const totalParticipants = groupReports.reduce((sum, report) => sum + report.participants.length, 0);
                const lastReport = groupReports.length > 0 ? groupReports[groupReports.length - 1] : null;
                
                const groupCard = document.createElement('div');
                groupCard.className = 'group-card';
                groupCard.innerHTML = `
                    <h3><span class="group-badge group-${group.id}" style="font-size: 1rem;">${group.name}</span></h3>
                    
                    <div class="group-leaders">
                        <p><i class="fas fa-user-tie"></i> Team Leaders</p>
                        <div>${group.leaders.join(', ')}</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">${group.members.length}</div>
                            <div style="font-size: 0.9rem; color: #666;">Members</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #4CAF50;">${totalSouls}</div>
                            <div style="font-size: 0.9rem; color: #666;">Souls Won</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>Recent Activity:</strong>
                        <p style="margin-top: 5px; font-size: 0.9rem;">
                            ${groupReports.length > 0 
                                ? `${groupReports.length} outreaches, ${totalParticipants} total participations. Last: ${formatDate(lastReport.date)}`
                                : 'No evangelism reports yet.'}
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <strong>Members List:</strong>
                    </div>
                    <div class="group-members">
                        ${group.members.map(member => `
                            <div class="member-card">${member}</div>
                        `).join('')}
                    </div>
                `;
                
                groupsContainer.appendChild(groupCard);
            });
        }

        // ============================================
        // CALENDAR FUNCTIONS
        // ============================================
        let calendar;

        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: generateCalendarEvents(),
                eventClick: function(info) {
                    alert('Event: ' + info.event.title + '\nDate: ' + info.event.start.toLocaleDateString());
                }
            });
            
            calendar.render();
        }

        function generateCalendarEvents() {
            const events = [];
            
            // Add evangelism events from reports
            evangelismData.reports.forEach(report => {
                events.push({
                    title: `Evangelism: ${report.location}`,
                    start: report.date,
                    backgroundColor: getGroupColor(report.group),
                    borderColor: getGroupColor(report.group)
                });
            });
            
            // Add follow-up events
            evangelismData.followups.forEach(followup => {
                events.push({
                    title: `Follow-up: ${followup.person}`,
                    start: followup.date,
                    backgroundColor: followup.status === 'completed' ? '#28a745' : 
                                   followup.status === 'overdue' ? '#dc3545' : '#ffc107',
                    borderColor: followup.status === 'completed' ? '#28a745' : 
                                followup.status === 'overdue' ? '#dc3545' : '#ffc107'
                });
            });
            
            return events;
        }

        function addCalendarEvent() {
            const title = prompt('Enter event title:');
            if (title) {
                const today = new Date().toISOString().split('T')[0];
                calendar.addEvent({
                    title: title,
                    start: today,
                    backgroundColor: '#4A0072',
                    borderColor: '#4A0072'
                });
                showNotification('Event added to calendar', 'success');
            }
        }

        function goToToday() {
            calendar.today();
        }

        // ============================================
        // ANALYTICS FUNCTIONS
        // ============================================
        function loadAnalyticsPage() {
            const period = document.getElementById('analyticsPeriod').value;
            let filteredReports = evangelismData.reports;
            
            // Filter by period
            const now = new Date();
            let startDate = new Date(now);
            
            switch (period) {
                case 'week':
                    startDate.setDate(now.getDate() - 7);
                    break;
                case 'month':
                    startDate.setMonth(now.getMonth() - 1);
                    break;
                case 'quarter':
                    startDate.setMonth(now.getMonth() - 3);
                    break;
                case 'year':
                    startDate.setFullYear(now.getFullYear() - 1);
                    break;
                case 'all':
                    startDate = null;
                    break;
            }
            
            if (startDate) {
                filteredReports = filteredReports.filter(report => {
                    const reportDate = new Date(report.date);
                    return reportDate >= startDate;
                });
            }
            
            // Calculate analytics
            const avgSouls = filteredReports.length > 0 ? 
                (filteredReports.reduce((sum, report) => sum + report.soulsWon, 0) / filteredReports.length).toFixed(1) : 0;
            
            // Find top location
            const locationCounts = {};
            filteredReports.forEach(report => {
                locationCounts[report.location] = (locationCounts[report.location] || 0) + 1;
            });
            
            let topLocation = '-';
            let maxCount = 0;
            for (const [location, count] of Object.entries(locationCounts)) {
                if (count > maxCount) {
                    maxCount = count;
                    topLocation = location;
                }
            }
            
            // Find top participant
            const participantCounts = {};
            filteredReports.forEach(report => {
                report.participants.forEach(participant => {
                    participantCounts[participant] = (participantCounts[participant] || 0) + 1;
                });
            });
            
            let topParticipant = '-';
            let maxParticipations = 0;
            for (const [participant, count] of Object.entries(participantCounts)) {
                if (count > maxParticipations) {
                    maxParticipations = count;
                    topParticipant = participant;
                }
            }
            
            // Calculate conversion rate
            const totalReached = filteredReports.reduce((sum, report) => sum + report.totalReached, 0);
            const totalSouls = filteredReports.reduce((sum, report) => sum + report.soulsWon, 0);
            const conversionRate = totalReached > 0 ? ((totalSouls / totalReached) * 100).toFixed(1) : 0;
            
            // Update analytics cards
            document.getElementById('avgSouls').textContent = avgSouls;
            document.getElementById('topLocation').textContent = topLocation;
            document.getElementById('topParticipant').textContent = topParticipant;
            document.getElementById('conversionRateDetailed').textContent = `${conversionRate}%`;
            document.getElementById('locationStats').textContent = `${maxCount} reports`;
            document.getElementById('participantStats').textContent = `${maxParticipations} outreaches`;
            
            // Update analytics charts
            updateAnalyticsCharts(filteredReports);
            updateAnalyticsTable(filteredReports);
        }

        function updateAnalyticsCharts(reports) {
            // Update performance chart
            const groupMetrics = [];
            
            for (let i = 1; i <= 4; i++) {
                const groupReports = reports.filter(r => r.group === i.toString());
                
                if (groupReports.length === 0) {
                    continue;
                }
                
                const soulsWon = groupReports.reduce((sum, report) => sum + report.soulsWon, 0);
                const participation = groupReports.reduce((sum, report) => sum + report.participants.length, 0);
                const followups = groupReports.reduce((sum, report) => sum + (report.followups || 0), 0);
                const locations = new Set(groupReports.map(r => r.location)).size;
                const testimonies = groupReports.filter(r => r.testimonies && r.testimonies.trim()).length;
                
                groupMetrics.push({
                    label: `Group ${i}`,
                    data: [
                        Math.min(100, soulsWon * 2),
                        Math.min(100, participation),
                        Math.min(100, followups * 5),
                        Math.min(100, locations * 10),
                        Math.min(100, (testimonies / groupReports.length) * 100)
                    ],
                    borderColor: getGroupColor(i),
                    backgroundColor: getGroupColor(i, 0.2)
                });
            }
            
            charts.performanceChart.data.datasets = groupMetrics;
            charts.performanceChart.update();
            
            // Update monthly chart
            const monthlyData = {};
            const groupColors = [
                'rgb(74, 0, 114)',
                'rgb(138, 43, 226)',
                'rgb(255, 215, 0)',
                'rgb(156, 39, 176)'
            ];
            
            reports.forEach(report => {
                const date = new Date(report.date);
                const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = [0, 0, 0, 0];
                }
                
                const groupIndex = parseInt(report.group) - 1;
                if (groupIndex >= 0 && groupIndex < 4) {
                    monthlyData[monthYear][groupIndex] += report.soulsWon;
                }
            });
            
            const sortedMonths = Object.keys(monthlyData).sort();
            const datasets = [];
            
            for (let i = 0; i < 4; i++) {
                datasets.push({
                    label: `Group ${i + 1}`,
                    data: sortedMonths.map(month => monthlyData[month][i]),
                    borderColor: groupColors[i],
                    backgroundColor: groupColors[i] + '20',
                    fill: true,
                    tension: 0.4
                });
            }
            
            charts.monthlyChart.data.labels = sortedMonths.map(month => formatMonth(month));
            charts.monthlyChart.data.datasets = datasets;
            charts.monthlyChart.update();
            
            // Update follow-up status chart
            const completed = evangelismData.followups.filter(f => f.status === 'completed').length;
            const pending = evangelismData.followups.filter(f => f.status === 'pending').length;
            const overdue = evangelismData.followups.filter(f => f.status === 'overdue').length;
            
            charts.followupStatusChart.data.datasets[0].data = [completed, pending, overdue];
            charts.followupStatusChart.update();
            
            // Update outreach types chart
            const outreachCount = reports.filter(r => r.reportType === 'outreach').length;
            const followupCount = reports.filter(r => r.reportType === 'followup').length;
            const trainingCount = reports.filter(r => r.reportType === 'training').length;
            
            charts.outreachTypesChart.data.datasets[0].data = [outreachCount, followupCount, trainingCount];
            charts.outreachTypesChart.update();
        }

        function updateAnalyticsTable(reports) {
            const tableBody = document.getElementById('analyticsTableBody');
            tableBody.innerHTML = '';
            
            const metrics = [
                { name: 'Total Reports', calc: (groupReports) => groupReports.length },
                { name: 'Souls Won', calc: (groupReports) => groupReports.reduce((sum, r) => sum + r.soulsWon, 0) },
                { name: 'Total Reached', calc: (groupReports) => groupReports.reduce((sum, r) => sum + r.totalReached, 0) },
                { name: 'Conversion Rate', calc: (groupReports) => {
                    const reached = groupReports.reduce((sum, r) => sum + r.totalReached, 0);
                    const souls = groupReports.reduce((sum, r) => sum + r.soulsWon, 0);
                    return reached > 0 ? ((souls / reached) * 100).toFixed(1) + '%' : '0%';
                }},
                { name: 'Avg. Participants', calc: (groupReports) => 
                    groupReports.length > 0 ? (groupReports.reduce((sum, r) => sum + r.participants.length, 0) / groupReports.length).toFixed(1) : 0
                }
            ];
            
            metrics.forEach(metric => {
                const row = document.createElement('tr');
                let cellsHtml = `<td><strong>${metric.name}</strong></td>`;
                
                let total = 0;
                
                for (let i = 1; i <= 4; i++) {
                    const groupReports = reports.filter(r => r.group === i.toString());
                    const value = metric.calc(groupReports);
                    cellsHtml += `<td>${value}</td>`;
                    
                    if (typeof value === 'number') {
                        total += value;
                    }
                }
                
                if (typeof total === 'number') {
                    cellsHtml += `<td><strong>${metric.name.includes('Rate') ? total.toFixed(1) + '%' : total}</strong></td>`;
                } else {
                    cellsHtml += `<td>-</td>`;
                }
                
                row.innerHTML = cellsHtml;
                tableBody.appendChild(row);
            });
        }

        // ============================================
        // EXPORT FUNCTIONS
        // ============================================
        function exportToPDF() {
            if (currentUser.role === 'guest' || currentUser.role === 'team-leader') {
                showNotification('You do not have permission to export data', 'warning');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(20);
            doc.setTextColor(74, 0, 114);
            doc.text(SYSTEM_CONFIG.churchName, 105, 20, { align: 'center' });
            
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text('Evangelism Report Summary', 105, 30, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 40, { align: 'center' });
            
            // Summary
            const totalSouls = evangelismData.reports.reduce((sum, report) => sum + report.soulsWon, 0);
            const totalReports = evangelismData.reports.length;
            const totalParticipants = evangelismData.reports.reduce((sum, report) => sum + report.participants.length, 0);
            
            doc.setFontSize(14);
            doc.text('Summary Statistics', 20, 60);
            
            doc.setFontSize(12);
            doc.text(`Total Reports: ${totalReports}`, 20, 75);
            doc.text(`Total Souls Won: ${totalSouls}`, 20, 85);
            doc.text(`Total Participants: ${totalParticipants}`, 20, 95);
            
            // Recent Reports
            doc.setFontSize(14);
            doc.text('Recent Evangelism Reports', 20, 115);
            
            doc.setFontSize(10);
            let yPos = 130;
            evangelismData.reports.slice(0, 5).forEach(report => {
                doc.text(`${formatDate(report.date)} - ${report.location} (Group ${report.group}) - ${report.soulsWon} souls`, 20, yPos);
                yPos += 7;
            });
            
            // Footer
            doc.setFontSize(10);
            doc.text('Approved by: ________________________', 20, 280);
            doc.text('Pastor AKIN', 20, 285);
            doc.text('CAC GOOD WORKS ASSEMBLY', 20, 290);
            
            doc.save(`Evangelism-Report-${new Date().toISOString().slice(0, 10)}.pdf`);
            
            showNotification('PDF report generated successfully', 'success');
        }

        function exportToExcel() {
            if (currentUser.role === 'guest' || currentUser.role === 'team-leader') {
                showNotification('You do not have permission to export data', 'warning');
                return;
            }
            
            const excelData = evangelismData.reports.map(report => ({
                Date: report.date,
                Group: report.group,
                Location: report.location,
                'Team Leader': report.teamLeader,
                Participants: report.participants.length,
                'Total Reached': report.totalReached,
                'Souls Won': report.soulsWon,
                'Follow-ups': report.followups,
                'Report Type': report.reportType,
                'Submitted By': report.submittedBy
            }));
            
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Evangelism Reports");
            
            for (let i = 1; i <= 4; i++) {
                const groupReports = evangelismData.reports.filter(r => r.group === i.toString());
                if (groupReports.length > 0) {
                    const groupData = groupReports.map(report => ({
                        Date: report.date,
                        Location: report.location,
                        'Team Leader': report.teamLeader,
                        Participants: report.participants.length,
                        'Total Reached': report.totalReached,
                        'Souls Won': report.soulsWon
                    }));
                    
                    const groupWs = XLSX.utils.json_to_sheet(groupData);
                    XLSX.utils.book_append_sheet(wb, groupWs, `Group ${i}`);
                }
            }
            
            XLSX.writeFile(wb, `Evangelism-Data-${new Date().toISOString().slice(0, 10)}.xlsx`);
            showNotification('Excel file exported successfully', 'success');
        }

        function exportToJSON() {
            if (currentUser.role === 'guest' || currentUser.role === 'team-leader') {
                showNotification('You do not have permission to export data', 'warning');
                return;
            }
            
            const exportData = {
                church: SYSTEM_CONFIG.churchName,
                exportDate: new Date().toISOString(),
                data: evangelismData
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', `evangelism-backup-${new Date().toISOString().slice(0, 10)}.json`);
            linkElement.click();
            
            showNotification('Backup file exported successfully', 'success');
        }

        function exportToPrint() {
            window.print();
            showNotification('Printing initiated', 'info');
        }

        function generateCustomExport() {
            showNotification('Custom export would be generated based on selected filters', 'info');
            // Implementation would combine filtering logic with export generation
        }

        function previewExport() {
            showNotification('Export preview would show here', 'info');
        }

        // ============================================
        // SETTINGS FUNCTIONS
        // ============================================
        function loadSettingsPage() {
            updateStorageInfo();
            
            // Set current theme
            document.querySelectorAll('[data-theme]').forEach(btn => {
                if (btn.getAttribute('data-theme') === evangelismData.settings.theme) {
                    btn.style.borderColor = btn.style.backgroundColor;
                } else {
                    btn.style.borderColor = '#ddd';
                }
            });
            
            // Set current layout
            document.getElementById('dashboardLayout').value = evangelismData.settings.layout;
        }

        function showPasswordModal() {
            document.getElementById('passwordModal').style.display = 'flex';
        }

        function hidePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('passwordForm').reset();
        }

        function handlePasswordChange(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showNotification('New passwords do not match', 'error');
                return;
            }
            
            // In a real app, this would validate against stored password
            showNotification('Password changed successfully', 'success');
            hidePasswordModal();
        }

        function clearLocalData() {
            if (confirm('This will clear all locally stored data. This action cannot be undone. Are you sure?')) {
                localStorage.clear();
                location.reload();
            }
        }

        function forceSync() {
            if (!isOnline) {
                showNotification('Cannot sync while offline', 'warning');
                return;
            }
            
            showNotification('Syncing data with server...', 'info');
            setTimeout(() => {
                showNotification('Data sync completed', 'success');
            }, 2000);
        }

        function saveSettings() {
            evangelismData.settings.layout = document.getElementById('dashboardLayout').value;
            saveLocalData();
            
            // Apply theme
            document.documentElement.style.setProperty('--primary', getThemeColor(evangelismData.settings.theme));
            
            showNotification('Settings saved successfully', 'success');
        }

        function getThemeColor(theme) {
            const themes = {
                default: '#4A0072',
                dark: '#2C3E50',
                red: '#8B0000',
                green: '#006400'
            };
            return themes[theme] || '#4A0072';
        }

        function updateStorageInfo() {
            const dataSize = JSON.stringify(evangelismData).length;
            const sizeInKB = (dataSize / 1024).toFixed(2);
            
            document.getElementById('storageInfo').innerHTML = `
                <p><strong>Used:</strong> ${sizeInKB} KB</p>
                <p><strong>Reports:</strong> ${evangelismData.reports.length}</p>
                <p><strong>Follow-ups:</strong> ${evangelismData.followups.length}</p>
            `;
            
            document.getElementById('storageUsage').textContent = `${sizeInKB} KB`;
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            const offlineBanner = document.getElementById('offlineBanner');
            const connectionIcon = document.getElementById('connectionIcon');
            const connectionStatus = document.getElementById('connectionStatus');
            
            if (isOnline) {
                offlineBanner.style.display = 'none';
                connectionIcon.className = 'fas fa-wifi online';
                connectionStatus.textContent = 'Online - Connected';
                connectionStatus.style.color = '#28a745';
                
                if (useFirebase) {
                    document.getElementById('syncStatus').innerHTML = '<i class="fas fa-sync syncing"></i> Last Sync: Just now';
                }
            } else {
                offlineBanner.style.display = 'block';
                connectionIcon.className = 'fas fa-wifi-slash offline';
                connectionStatus.textContent = 'Offline - Local Mode';
                connectionStatus.style.color = '#ff9800';
                document.getElementById('syncStatus').innerHTML = '<i class="fas fa-sync-alt offline"></i> Last Sync: When online';
            }
            
            document.getElementById('storageStatus').innerHTML = `<i class="fas fa-database"></i> Local Storage: ${evangelismData.reports.length} reports`;
        }

        function showNotification(message, type = 'info') {
            // Create notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 10px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                animation: slideInRight 0.3s, fadeOut 0.3s 2.7s;
            `;
            
            const colors = {
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107',
                info: '#17a2b8'
            };
            
            notification.style.backgroundColor = colors[type] || '#17a2b8';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        function formatDate(dateString, short = false) {
            const date = new Date(dateString);
            if (short) {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function formatMonth(monthString) {
            const [year, month] = monthString.split('-');
            const date = new Date(year, month - 1, 1);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short' 
            });
        }

        function getFirstDayOfMonth() {
            const date = new Date();
            date.setDate(1);
            return date.toISOString().split('T')[0];
        }

        function getGroupColor(groupNumber, opacity = 1) {
            const colors = [
                `rgba(74, 0, 114, ${opacity})`,
                `rgba(138, 43, 226, ${opacity})`,
                `rgba(255, 215, 0, ${opacity})`,
                `rgba(156, 39, 176, ${opacity})`
            ];
            return colors[groupNumber - 1] || colors[0];
        }

        // ============================================
        // INITIALIZE APPLICATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                document.getElementById('mainContent').style.display = 'grid';
                
                updateUserInterface();
                initApp();
            } else {
                setupLoginListeners();
            }
        });
    </script>
</body>
</html>
